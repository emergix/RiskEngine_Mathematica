(*******************************************************************
This file was generated automatically by the Mathematica front end.
It contains Initialization cells from a Notebook file, which
typically will have the same name as this file except ending in
".nb" instead of ".m".

This file is intended to be loaded into the Mathematica kernel using
the package loading commands Get or Needs.  Doing so is equivalent
to using the Evaluate Initialization Cells menu command in the front
end.

DO NOT EDIT THIS FILE.  This entire file is regenerated
automatically each time the parent Notebook file is saved in the
Mathematica front end.  Any changes you make to this file will be
overwritten.
***********************************************************************)

<< "C:\\Documents and Settings\\ocroissant\\My Documents\\NumericalIntegration.m"

<< "C:\\Documents and Settings\\ocroissant\\My Documents\\BS.m"

<< "C:\\Documents and Settings\\ocroissant\\My Documents\\SABR.m"

<< "C:\\Documents and Settings\\ocroissant\\My Documents\\NormalHeston.m"

<<Graphics`ImplicitPlot`

<<Graphics`Legend`

<<Statistics`ContinuousDistributions`

<<Statistics`MultinormalDistribution`

<<Graphics`MultipleListPlot`

Off[General::"spell"]





\!\(GIntegralAnalytical[a1_, b1_, x1_] := Module[{a, b, x}, \[IndentingNewLine]x = Abs[x1]; \[IndentingNewLine]b = Abs[b1]; \[IndentingNewLine]a = Abs[a1]; \[IndentingNewLine]Re[If[Abs[a] > 0.001, Sign[x1] \((\(\@\[Pi]\/\(\(\ \)\(4  a\)\)\) \((\[ExponentialE]\^\(\(-\ 2\) a\ \ b\)\ \ \((1 - \[ExponentialE]\^\(4\ \ a\ b\) + \[ExponentialE]\^\(4\ \ a\ b\)\ Erf[b\/x + a\ x] - Erf[\(\(\ \)\(b\)\)\/\(\(\ \)\(x\)\) - a\ x])\))\))\), \[IndentingNewLine]Sign[x1] \((\((\(-b\)\ \@\[Pi] + \[ExponentialE]\^\(-\(b\^2\/x\^2\)\)\ x + b\ \@\[Pi]\ Erf[b\/x])\) + 1\/3\ \((\(-\[ExponentialE]\^\(-\(b\^2\/x\^2\)\)\)\ \((2  b\^3\ \[ExponentialE]\^\(b\^2\/x\^2\)\ \@\[Pi] - 2\ b\^2\ x + x\^3)\) + 2  b\^3\ \@\[Pi]\ Erf[b\/x])\)\ a\^2 + 1\/30\ \[ExponentialE]\^\(-\(b\^2\/x\^2\)\)\ \((\(-4\)\ b\^5\ \[ExponentialE]\^\(b\^2\/x\^2\)\ \@\[Pi] + 4\ b\^4\ x - 2\ b\^2\ x\^3 + 3\ x\^5 + 4\ b\^5\ \[ExponentialE]\^\(b\^2\/x\^2\)\ \@\[Pi]\ Erf[b\/x])\)\ a\^4)\)\[IndentingNewLine]]]]\)







\!\(GIntegralAnalytical1[a1_, b1_, x1_] := Module[{a, b, x}, \[IndentingNewLine]x = Abs[x1]; \[IndentingNewLine]b = Abs[b1]; \[IndentingNewLine]a = Abs[a1]; \[IndentingNewLine]Re[If[Abs[a] > 0.001, Sign[x1] \(\(\[ExponentialE]\^\(\(-2\)\ a\ b\)\)\(\ \)\(\@\[Pi]\)\(\ \)\((1 - \[ExponentialE]\^\(4\ a\ b\) - NormalCDF[\@2\ \((b\/x - a\ x)\)] + \[ExponentialE]\^\(4\ a\ b\)\ NormalCDF[\@2\ \((b\/x + a\ x)\)])\)\(\ \)\)\/\(2\ a\), \[IndentingNewLine]Sign[x1]\/30\ \((\[ExponentialE]\^\(-\(b\^2\/x\^2\)\)\ x\ \((30 + 10\ a\^2\ \((2\ b\^2 - x\^2)\) + a\^4\ \((4\ b\^4 - 2\ b\^2\ x\^2 + 3\ x\^4)\))\) + 4\ b\ \((15 + 10\ a\^2\ b\^2 + 2\ a\^4\ b\^4)\)\ \@\[Pi]\ \((\(-1\) + NormalCDF[\(\@2\ b\)\/x])\))\)\[IndentingNewLine]]]]\)



\!\(BiSABRIntegral[A_, B_, G_, F_, \[Gamma]_] := Module[{r}, \[IndentingNewLine]\[IndentingNewLine]\ Print["\<A=\>", A, "\< B=\>", B, "\< G=\>", G, "\< F=\>", F, "\< \[Gamma]=\>", \[Gamma], "\< roots=\>", NSolve[r\^\(\(2\)\(\ \)\) - \ r\ G\  + F \[Equal] 0, r], \[IndentingNewLine]"\< X1=\>", AppellF1[1 + \[Gamma], 1\/2, 1\/2, 2 + \[Gamma], \(2\ A\)\/\(G - \@\(\(-4\)\ F + G\^2\)\), \(2\ A\)\/\(G + \@\(\(-4\)\ F + G\^2\)\)], \[IndentingNewLine]"\< X2=\>", AppellF1[1 + \[Gamma], 1\/2, 1\/2, 2 + \[Gamma], \(2\ B\)\/\(G - \@\(\(-4\)\ F + G\^2\)\), \(2\ B\)\/\(G + \@\(\(-4\)\ F + G\^2\)\)]]; \[IndentingNewLine]\[IndentingNewLine]\[IndentingNewLine]\(1\/\(\@F\ \ \((1 + \[Gamma])\)\)\) \((\(-A\^\(1 + \[Gamma]\)\)\ \ AppellF1[1 + \[Gamma], 1\/2, 1\/2, 2 + \[Gamma], \(2\ A\)\/\(G - \@\(\(-4\)\ F + G\^2\)\), \(2\ A\)\/\(G + \@\(\(-4\)\ F + G\^2\)\)] + B\^\(1 + \[Gamma]\)\ \ AppellF1[1 + \[Gamma], 1\/2, 1\/2, 2 + \[Gamma], \(2\ B\)\/\(G - \@\(\(-4\)\ F + G\^2\)\), \(2\ B\)\/\(G + \@\(\(-4\)\ F + G\^2\)\)])\)]\)

BiSABRIntegral[A_,B_,G_,F_,\[Gamma]_]:=
  Module[{legendrelst=LegendreCoeffs[10]},
    BiSABRIntegralN[A,B,G,F,\[Gamma],legendrelst]]

\!\(BiSABRIntegralN[A_, B_, G_, F_, \[Gamma]_, legendrelst_] := Module[{}, \[IndentingNewLine]CoeffBasedIntegrate[\((#\^\[Gamma]\/\@\(#\^\(\(2\)\(\ \)\) - \ #  G\  + F\))\) &, LegendreCoeffsFromLegendre[legendrelst, A, B]]\[IndentingNewLine]]\)





























\!\(BiSABRz[K_, F1_, F2_, \[Alpha]1_, \[Alpha]2_, \[Rho]s_, \[Beta]1_, \[Beta]2_] := \(1\/\(\[Alpha]1\ \[Beta]1\)\) BiSABRIntegral[\((K + F2)\)\^\[Beta]1, \((F1)\)\^\[Beta]1, \(2\ \ F2\^\[Beta]2\ \ \[Alpha]2\ \[Rho]s\)\/\[Alpha]1, F2\^\(2\ \[Beta]2\)\ \((\[Alpha]2\/\[Alpha]1)\)\^2, \(1 - \[Beta]1\)\/\[Beta]1]\)

\!\(BiSABRz[K_, F1_, F2_, \[Alpha]1_, \[Alpha]2_, \[Rho]s_, \[Beta]1_, \[Beta]2_, legendrelst_] := \(1\/\(\[Alpha]1\ \[Beta]1\)\) BiSABRIntegralN[\((K + F2)\)\^\[Beta]1, \((F1)\)\^\[Beta]1, \(2\ \ F2\^\[Beta]2\ \ \[Alpha]2\ \[Rho]s\)\/\[Alpha]1, F2\^\(2\ \[Beta]2\)\ \((\[Alpha]2\/\[Alpha]1)\)\^2, \(1 - \[Beta]1\)\/\[Beta]1, legendrelst]\)

















































































































































\!\(\[Nu]BiSABR1[F1_, \[Alpha]1_, \[Beta]1_, \[Rho]1_, \[Nu]1_, F2_, \[Alpha]2_, \[Beta]2_, \[Rho]2_, \[Nu]2_, \[Rho]s_, \[Rho]v_, \[Rho]c12_, \[Rho]c21_, X1_, X2_, \[Alpha]s_] := Module[{term1, term2, term3}, \[IndentingNewLine]term1 = X1\^\(\(4\)\(\ \)\)\ \[Alpha]1\^4\ \((\((X1\/F1)\)\^2\ \[Alpha]1\^2\ \[Beta]1\^2 + \[Nu]1\^2 + 2\ X1\/F1\ \[Alpha]1\ \[Beta]1\ \[Nu]1\ \[Rho]1)\); \[IndentingNewLine]term2 = X2\^\(\(4\)\(\ \)\)\ \[Alpha]2\^4\ \((\((X2\/F2)\)\^2\ \[Alpha]2\^2\ \[Beta]2\^2 + \[Nu]2\^2 + 2  X2\/F2\ \[Alpha]2\ \[Beta]2\ \[Nu]2\ \[Rho]2)\); \[IndentingNewLine]term3 = X1\^\(\(2\)\(\ \)\)\ X2\^\(\(2\)\(\ \)\)\ \[Alpha]1\^2\ \[Alpha]2\^2\ \((\((X1\/F1)\)\^2\ \[Alpha]1\^2\ \[Beta]1\^2\ \[Rho]s\^2 + \((X2\/F2)\)\^2\ \ \[Alpha]2\^2\ \[Beta]2\^2\ \[Rho]s\^2 + \[Nu]1\^2\ \[Rho]s\^2 + \[Nu]2\^2\ \[Rho]s\^2 + 2\ X2\/F2\ \[Alpha]2\ \[Beta]2\ \((\[Nu]2\ \[Rho]2\ \[Rho]s\^2 + \[Nu]1\ \[Rho]c21\ \((1 + \[Rho]s\^2)\))\) + 2  X1\/F1\ \[Alpha]1\ \[Beta]1\ \((\[Nu]1\ \[Rho]1\ \[Rho]s\^2 + \[Nu]2\ \[Rho]c12\ \((1 + \[Rho]s\^2)\) + X2\/F2\ \[Alpha]2\ \[Beta]2\ \[Rho]s\ \((1 + \[Rho]s\^2)\))\) + 2\ \[Nu]1\ \[Nu]2\ \[Rho]v + 2\ \[Nu]1\ \[Nu]2\ \[Rho]s\^2\ \[Rho]v)\); \[IndentingNewLine]term4 = 2\ X1\ \ X2\^\(\(3\)\(\ \)\)\ \[Alpha]1\ \[Alpha]2\^3\ \[Rho]s\ \((F2\^\(\(-2\) + 2\ \[Beta]2\)\ \[Alpha]2\^2\ \[Beta]2\^2 + \(F2\^\(\(-1\) + \[Beta]2\)\ \[Alpha]2\ \[Beta]2\ \((2\ F1\ \[Nu]2\ \[Rho]2 + F1\ \[Nu]1\ \[Rho]c21 + F1\^\[Beta]1\ \[Alpha]1\ \[Beta]1\ \[Rho]s)\)\)\/F1 + \[Nu]2\ \((\[Nu]2 + X1\/F1\ \[Alpha]1\ \[Beta]1\ \[Rho]c12 + \[Nu]1\ \[Rho]v)\))\); \[IndentingNewLine]term5 = 2\ X1\^\(\(3\)\(\ \)\)\ X2\ \[Alpha]1\^3\ \[Alpha]2\ \[Rho]s\ \((\((X1\/F1)\)\^2\ \[Alpha]1\^2\ \[Beta]1\^2 + X1\/F1\ \[Alpha]1\ \[Beta]1\ \((2\ \[Nu]1\ \[Rho]1 + \[Nu]2\ \[Rho]c12 + X2\/F2\ \[Alpha]2\ \[Beta]2\ \[Rho]s)\) + \[Nu]1\ \((\[Nu]1 + X2\/F2\ \[Alpha]2\ \[Beta]2\ \[Rho]c21 + \[Nu]2\ \[Rho]v)\))\); \[IndentingNewLine]\@\(term1 + term2 + term3 - term4 - term5\)\/\[Alpha]s\^2]\)

\!\(\[Rho]BiSABR1[F1_, \[Alpha]1_, \[Beta]1_, \[Rho]1_, \[Nu]1_, F2_, \[Alpha]2_, \[Beta]2_, \[Rho]2_, \[Nu]2_, \[Rho]s_, \[Rho]v_, \[Rho]c12_, \[Rho]c21_, X1_, X2_, \[Alpha]s_, \[Nu]s_] := Module[{}, \[IndentingNewLine]\((X1\^3\ \[Alpha]1\^3\ \((\(X1\ \[Alpha]1\ \[Beta]1\)\/F1 + \[Nu]1\ \[Rho]1)\) - X2\^3\ \[Alpha]2\^3\ \((\(X2\ \[Alpha]2\ \[Beta]2\)\/F2 + \[Nu]2\ \[Rho]2)\) - X1\^2\ X2\ \[Alpha]1\^2\ \[Alpha]2\ \((\[Rho]s\ \((\(2\ X1\ \[Alpha]1\ \[Beta]1\)\/F1 + \[Nu]2\ \[Rho]c12 + \(X2\ \[Alpha]2\ \[Beta]2\ \[Rho]s\)\/F2)\) + \[Nu]1\ \((\[Rho]c21 + \[Rho]1\ \[Rho]s)\))\) + X1\ X2\^2\ \[Alpha]1\ \[Alpha]2\^2\ \((\[Rho]s\ \((\(2\ X2\ \[Alpha]2\ \[Beta]2\)\/F2 + \[Nu]1\ \[Rho]c21 + \(X1\ \[Alpha]1\ \[Beta]1\ \[Rho]s\)\/F1)\) + \[Nu]2\ \((\[Rho]c12 + \[Rho]2\ \[Rho]s)\))\))\)/\((\[Nu]s\ \[Alpha]s\^3)\)]\)













\!\(\[Mu]BiSABR1[F1_, \[Alpha]1_, \[Beta]1_, \[Rho]1_, \[Nu]1_, F2_, \[Alpha]2_, \[Beta]2_, \[Rho]2_, \[Nu]2_, \[Rho]s_, \[Rho]v_, \[Rho]c12_, \[Rho]c21_, X1_, X2_, \[Alpha]s_] := Module[{term1, term2, term3, term4}, \[IndentingNewLine]term1 = F1\^2\ X2\^\(\(6\)\(\ \)\)\ \[Alpha]2\^6\ \((\(-1\) + \[Beta]2)\)\ \[Beta]2 + X1\^\(\(5\)\(\ \)\)\ F2\^2\ \[Alpha]1\^5\ \[Beta]1\ \((X1\ \[Alpha]1\ \((\(-1\) + \[Beta]1)\) + 2\ F1\ \[Nu]1\ \[Rho]1)\); \[IndentingNewLine]term2 = \(-3\)\ X1\^\(\(4\)\(\ \)\)\ X2\ F2\^2\ \[Alpha]1\^4\ \[Alpha]2\ \[Beta]1\ \((X1\ \[Alpha]1\ \((\(-1\) + \[Beta]1)\) + 2\ F1\ \[Nu]1\ \[Rho]1)\)\ \[Rho]s + F1\^2\ X2\^\(\(5\)\(\ \)\)\ \[Alpha]2\^5\ \[Beta]2\ \((2\ F2\ \[Nu]2\ \[Rho]2 - 3\ X1\ \[Alpha]1\ \((\(-1\) + \[Beta]2)\)\ \[Rho]s)\) + X1\ F1\^2\ X2\^4\ \[Alpha]1\ \[Alpha]2\^4\ \[Beta]2\ \((\(-6\)\ F2\ \[Nu]2\ \[Rho]2\ \[Rho]s + X1\ \[Alpha]1\ \((\(-1\) + 2\ \[Beta]2 + \((\(-2\) + \[Beta]2)\)\ \[Rho]s\^2)\))\); \[IndentingNewLine]term3 = X1\^\(\(2\)\(\ \)\)\ X2\^3\ \[Alpha]1\^2\ \[Alpha]2\^3\ \((X1\ \[Alpha]1\ \[Rho]s\ \((\(-F2\^2\)\ \((\(-1\) + \[Beta]1)\)\ \[Beta]1 - F1\^2\ \((\(-1\) + \[Beta]2)\)\ \[Beta]2 + 2\ F1\ F2\ \[Beta]1\ \[Beta]2\ \((\(-1\) + \[Rho]s\^2)\))\) + 2\ F1\ F2\ \((\(-F2\)\ \[Beta]1\ \[Nu]1\ \[Rho]1\ \[Rho]s + F1\ \[Beta]2\ \((\[Nu]1\ \[Rho]c21\ \((\(-1\) + \[Rho]s\^2)\) + \[Nu]2\ \[Rho]2\ \((2 + \[Rho]s\^2)\))\))\))\); \[IndentingNewLine]term4 = X1\^\(\(2\)\(\ \)\)\ X2\^2\ F2\ \ \[Alpha]1\^2\ \[Alpha]2\^2\ \((X1\^2\ F2\ \[Alpha]1\^2\ \[Beta]1\ \((\(-1\) + 2\ \[Beta]1 + \((\(-2\) + \[Beta]1)\)\ \[Rho]s\^2)\) + 2\ X1\ F1\ \[Alpha]1\ \((\(-F1\)\ \[Beta]2\ \[Nu]2\ \[Rho]2\ \[Rho]s + F2\ \[Beta]1\ \((\[Nu]2\ \[Rho]c12\ \((\(-1\) + \[Rho]s\^2)\) + \[Nu]1\ \[Rho]1\ \((2 + \[Rho]s\^2)\))\))\) - F1\^2\ F2\ \((\(-1\) + \[Rho]s\^2)\)\ \((\[Nu]1\^2 + \[Nu]2\^2 - 2\ \[Nu]1\ \[Nu]2\ \[Rho]v)\))\); \[IndentingNewLine]\((term1 + term2 + term3 + term4)\)/\((2  F1\^2\ F2\^2\ \[Alpha]s\^3)\)]\)





\!\(BiSABRspreadC[F1_, F2_, \[Alpha]1_, \[Alpha]2_, \[Beta]1_, \[Beta]2_, \[Rho]s_, X1_, X2_, \[Alpha]s_, s_] := Module[{}, \[IndentingNewLine]If[Abs[s + F2] < 2\ 10^\((\(-3\))\) F2, \[IndentingNewLine]\((\(-2\^\[Beta]1\)\ F2\^\(\(-1\) + \[Beta]1\)\ \((F2 - s)\)\ \[Alpha]1\ \[Beta]1\ \((2\^\[Beta]1\ F2\^\[Beta]1\ \[Alpha]1 - X2\ \[Alpha]2\ \[Rho]s)\) + 2\ \((4\^\[Beta]1\ F2\^\(2\ \[Beta]1\)\ \[Alpha]1\^2 + X2\^2\ \[Alpha]2\^2 - 2\^\(1 + \[Beta]1\)\ F2\^\[Beta]1\ X2\ \[Alpha]1\ \[Alpha]2\ \[Rho]s)\) + \(2\^\(\(-2\) + \[Beta]1\)\ F2\^\(\(-2\) + \[Beta]1\)\ \((F2 - s)\)\^2\ \[Alpha]1\ \[Beta]1\ \((8\^\[Beta]1\ F2\^\(3\ \[Beta]1\)\ \[Alpha]1\^3\ \((\(-1\) + \[Beta]1)\) - 3\ 4\^\[Beta]1\ F2\^\(2\ \[Beta]1\)\ X2\ \[Alpha]1\^2\ \[Alpha]2\ \((\(-1\) + \[Beta]1)\)\ \[Rho]s - X2\^3\ \[Alpha]2\^3\ \((\(-1\) + \[Beta]1)\)\ \[Rho]s + 2\^\[Beta]1\ F2\^\[Beta]1\ X2\^2\ \[Alpha]1\ \[Alpha]2\^2\ \((\(-1\) - 2\ \[Rho]s\^2 + \[Beta]1\ \((2 + \[Rho]s\^2)\))\))\)\)\/\(4\^\[Beta]1\ F2\^\(2\ \[Beta]1\)\ \[Alpha]1\^2 + X2\^2\ \[Alpha]2\^2 - 2\^\(1 + \[Beta]1\)\ F2\^\[Beta]1\ X2\ \[Alpha]1\ \[Alpha]2\ \[Rho]s\))\)/\((2\ \[Alpha]s\ \@\(4\^\[Beta]1\ F2\^\(2\ \[Beta]1\)\ \[Alpha]1\^2 + X2\^2\ \[Alpha]2\^2 - 2\^\(1 + \[Beta]1\)\ F2\^\[Beta]1\ X2\ \[Alpha]1\ \[Alpha]2\ \[Rho]s\))\), \[IndentingNewLine]\@\(\((s + F2)\)\^\(2\ \[Beta]1\)\ \[Alpha]1\^2 + X2\^\(\(2\)\(\ \)\)\ \[Alpha]2\^2 - 2\ \((s + F2)\)\^\[Beta]1\ X2\ \[Alpha]1\ \[Alpha]2\ \[Rho]s\)\/\[Alpha]s]]\)







\!\(BiSABRspreadCderivative[F1_, F2_, \[Alpha]1_, \[Alpha]2_, \[Beta]1_, \[Beta]2_, \[Rho]s_, X1_, X2_, \[Alpha]s_, s_] := Module[{}, \[IndentingNewLine]\(\(\ \)\(\((s + F2)\)\^\(\(-1\) + 2\ \[Beta]1\)\ \[Alpha]1\^2\ \[Beta]1 - \ X2\ \((s + F2)\)\^\(\(-1\) + \[Beta]1\)\ \[Alpha]1\ \[Alpha]2\ \[Beta]1\ \[Rho]s\)\)\/\(\[Alpha]s\ \@\(\((s + F2)\)\^\(2\ \[Beta]1\)\ \[Alpha]1\^2 + X2\^\(\(2\)\(\ \)\)\ \[Alpha]2\^2 - 2\ \((s + F2)\)\^\[Beta]1\ X2\ \[Alpha]1\ \[Alpha]2\ \[Rho]s\)\)]\)

\!\(BiSABRspreadCderivative2[F1_, F2_, \[Alpha]1_, \[Alpha]2_, \[Beta]1_, \[Beta]2_, \[Rho]s_, X1_, X2_, \[Alpha]s_, s_] := Module[{}, \[IndentingNewLine]\((2\ \((s + F2)\)\^\(\(-1\) + 2\ \[Beta]1\)\ \[Alpha]1\^2\ \[Beta]1 - 2\ X2\ \((s + F2)\)\^\(\(-1\) + \[Beta]1\)\ \[Alpha]1\ \[Alpha]2\ \[Beta]1\ \[Rho]s)\)\^2\/\(4\ \((\@\(\((s + F2)\)\^\(2\ \[Beta]1\)\ \[Alpha]1\^2 + X2\^\(\(2\)\(\ \)\)\ \[Alpha]2\^2 - 2\ \((s + F2)\)\^\[Beta]1\ X2\ \[Alpha]1\ \[Alpha]2\ \[Rho]s\))\)\^3\) + \(2\ \((s + F2)\)\^\(\(-2\) + 2\ \[Beta]1\)\ \[Alpha]1\^2\ \[Beta]1\ \((\(-1\) + 2\ \[Beta]1)\) - 2\ F2\^\[Beta]2\ \((s + F2)\)\^\(\(-2\) + \[Beta]1\)\ \[Alpha]1\ \[Alpha]2\ \((\(-1\) + \[Beta]1)\)\ \[Beta]1\ \[Rho]s\)\/\(2\ \@\(\((s + F2)\)\^\(2\ \[Beta]1\)\ \[Alpha]1\^2 + X2\^\(\(2\)\(\ \)\)\ \[Alpha]2\^2 - 2\ \((s + F2)\)\^\[Beta]1\ X2\ \[Alpha]1\ \[Alpha]2\ \[Rho]s\)\)]\)





\!\(BiSABRSpreadOption[F1_, \[Alpha]1_, \[Beta]1_, \[Rho]1_, \[Nu]1_, F2_, \[Alpha]2_, \[Beta]2_, \[Rho]2_, \[Nu]2_, K_, T_, \[Rho]s_, \[Rho]v_, \[Rho]c12_, \[Rho]c21_, legendrelst_, printflag_] := Module[\[IndentingNewLine]{intrinsec, z, zb, b1, b2, SqB0B\[Alpha]z, favg, zavg, Ck, \[Alpha]sp, \[Nu]sp, \[Rho]sp, \[Mu]sp, X1, X2, Qs, Q1, Q2, Qb, C1, C2, C1p, C2p, Q, COV, COV1, COV0, \[Rho]sb, \[Rho]s\[Alpha]1, \[Rho]s\[Alpha]2, \[Rho]b\[Alpha]1, \[Rho]b\[Alpha]2, N1, N2, \[Nu]spZ, \[Rho]spZ}, \[IndentingNewLine]X1 = F1\^\(\(\ \)\(\[Beta]1\)\); X2 = F2\^\[Beta]2; \[Alpha]sp = \@\(X1\^\(\(2\)\(\ \)\)\ \[Alpha]1\^2 + X2\^\(\(2\)\(\ \)\)\ \[Alpha]2\^2 - 2\ X1\ X2\ \[Alpha]1\ \[Alpha]2\ \[Rho]s\); \[IndentingNewLine]If[printflag > 0, Print["\<X1=\>", X1, "\< X2=\>", X2, "\< \[Alpha]sp=\>", \[Alpha]sp]]; \[IndentingNewLine]\[Nu]sp = \[Nu]BiSABR1[F1, \[Alpha]1, \[Beta]1, \[Rho]1, \[Nu]1, F2, \[Alpha]2, \[Beta]2, \[Rho]2, \[Nu]2, \[Rho]s, \[Rho]v, \[Rho]c12, \[Rho]c21, X1, X2, \[Alpha]sp]; \[IndentingNewLine]\[Rho]sp = \[Rho]BiSABR1[F1, \[Alpha]1, \[Beta]1, \[Rho]1, \[Nu]1, F2, \[Alpha]2, \[Beta]2, \[Rho]2, \[Nu]2, \[Rho]s, \[Rho]v, \[Rho]c12, \[Rho]c21, X1, X2, \[Alpha]sp, \[Nu]sp]; \[IndentingNewLine]\[Mu]sp = \[Mu]BiSABR1[F1, \[Alpha]1, \[Beta]1, \[Rho]1, \[Nu]1, F2, \[Alpha]2, \[Beta]2, \[Rho]2, \[Nu]2, \[Rho]s, \[Rho]v, \[Rho]c12, \[Rho]c21, X1, X2, \[Alpha]sp]; \[IndentingNewLine]z = Re[BiSABRz[K, F1, F2, \[Alpha]1, \[Alpha]2, \[Rho]s, \[Beta]1, \[Beta]2]]; \[IndentingNewLine]zb = BiSABRz[K, F1, F2, \[Alpha]1, \[Alpha]2, \[Rho]s, \[Beta]1, \[Beta]2, legendrelst]; \[IndentingNewLine]If[printflag > 0, Print["\<BiSABRSpreadOption:z=\>", z, "\<zb=\>", zb]]; \[IndentingNewLine]favg = \((F1 - F2 + K)\)/2; \[IndentingNewLine]zavg = z; \[IndentingNewLine]b1 = BiSABRspreadCderivative[F1, F2, \[Alpha]1, \[Alpha]2, \[Beta]1, \[Beta]2, \[Rho]s, X1, X2, \[Alpha]sp, favg]; \[IndentingNewLine]Csecond = BiSABRspreadCderivative2[F1, F2, \[Alpha]1, \[Alpha]2, \[Beta]1, \[Beta]2, \[Rho]s, X1, X2, \[Alpha]sp, favg]; \[IndentingNewLine]Cfavg = BiSABRspreadC[F1, F2, \[Alpha]1, \[Alpha]2, \[Beta]1, \[Beta]2, \[Rho]s, X1, X2, \[Alpha]sp, favg]; \[IndentingNewLine]Ck = BiSABRspreadC[F1, F2, \[Alpha]1, \[Alpha]2, \[Beta]1, \[Beta]2, \[Rho]s, X1, X2, \[Alpha]sp, K]; \[IndentingNewLine]b2 = Csecond\ Cfavg + b1\^2; \[IndentingNewLine]SqB0B\[Alpha]z = \@Ck; \[IndentingNewLine]intrinsec = Max[F1 - F2 - K, 0]; \[IndentingNewLine]If[printflag > 0, Print["\<BiSABRSpreadOption:K=\>", K, "\< b1:Cprime[favg]=\>", b1, "\< Csecond[favg]=\>", Csecond, \ "\< b2=\>", b2, "\< Cfavg=\>", Cfavg]]; \[IndentingNewLine]If[printflag > 0, Print["\<BiSABRSpreadOption:\[Alpha]=\>", \[Alpha]sp, "\< \[Nu]=\>", \[Nu]sp, "\< \[Rho]=\>", \[Rho]sp, "\<  \[Mu]=\>", \[Mu]sp]]; \[IndentingNewLine]If[printflag > 0, Print["\<BiSABRSpreadOption:intrinsec Value=\>", intrinsec, "\<  z=\>", z, "\< SqB0B\[Alpha]z=\>", SqB0B\[Alpha]z]]; \[IndentingNewLine]If[printflag > 0, \[IndentingNewLine]C1 = F1^\[Beta]1; C2 = F2^\[Beta]2; C1p = \[Beta]1\ F1^\((\[Beta]1 - 1)\); C2p = \[Beta]2\ F2^\((\[Beta]2 - 1)\); \[IndentingNewLine]Q = \@\(\[Alpha]1\^2\ C1\^2 + \[Alpha]2\^2\ C2\^2 - 2  \[Rho]s\ \[Alpha]1\ \[Alpha]2\ C1\ C2\); \[IndentingNewLine]Qs = \[Alpha]1\^2\ C1\ \ C1p - \[Alpha]1\ \[Alpha]2\ \[Rho]s\ C2\ \ C1p; \[IndentingNewLine]Qb = \[Alpha]1\^2\ C1\ C1p - \[Alpha]1\ \[Alpha]2\ \[Rho]s\ C2\ \ C1p - \[Alpha]1\ \[Alpha]2\ \[Rho]s\ C1\ C2p + \[Alpha]2\^2\ C2\ C2p; \[IndentingNewLine]Q1 = \[Alpha]1\ C1\^2 - \[Alpha]2\ \[Rho]s\ C1\ C2; \[IndentingNewLine]Q2 = \(-\[Alpha]1\)\ \[Rho]s\ C1\ C2 + \[Alpha]2\ C2\^2; \[IndentingNewLine]\[Rho]sb = \((\ \[Rho]s\ \[Alpha]1\ C1 - \ \ \[Alpha]2\ C2)\)\/Q; \[IndentingNewLine]\[Rho]s\[Alpha]1 = \((\ \[Rho]1\ \ \[Alpha]1\ C1 - \ \[Rho]c21\ \[Alpha]2\ C2)\)\/Q; \[IndentingNewLine]\[Rho]s\[Alpha]2 = \((\[Rho]c12\ \[Alpha]1\ C1 - \ \[Rho]2\ \[Alpha]2\ C2)\)\/Q; \[IndentingNewLine]\[Rho]b\[Alpha]1 = \[Rho]c21; \[IndentingNewLine]\[Rho]b\[Alpha]2 = \[Rho]2; \[IndentingNewLine]COV0 = {\[IndentingNewLine]{\ \ \[Alpha]1\^2\ C1\^2, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]s\ \[Alpha]1\ C1\ \[Alpha]2\ \ C2\ , \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]1\ \ \[Alpha]1\ C1\ \[Nu]1\ \[Alpha]1, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]c12\ \[Alpha]1\ C1\ \[Nu]2\ \[Alpha]2}, \[IndentingNewLine]{\ \[Rho]s\ \[Alpha]1\ C1\ \[Alpha]2\ \ C2\ , \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \((\[Alpha]2\ \ C2)\)\^2, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]c21\ \[Alpha]2\ C2\ \[Nu]1\ \[Alpha]1, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]2\ \[Alpha]2\ C2\ \[Nu]2\ \[Alpha]2}, \[IndentingNewLine]{\ \[Rho]1\ \ \[Alpha]1\ C1\ \[Nu]1\ \[Alpha]1, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]c21\ \[Alpha]2\ C2\ \[Nu]1\ \ \[Alpha]1, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \((\[Nu]1\ \[Alpha]1)\)\^2, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]v\ \[Nu]1\ \[Alpha]1\ \[Nu]2\ \[Alpha]2}, \[IndentingNewLine]{\ \[Rho]c12\ \[Alpha]1\ C1\ \[Nu]2\ \[Alpha]2, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]2\ \[Alpha]2\ \ C2\ \[Nu]2\ \[Alpha]2\ , \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]v\ \[Nu]1\ \[Alpha]1\ \[Nu]2\ \[Alpha]2, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \((\[Nu]2\ \[Alpha]2)\)\^2}\[IndentingNewLine]}; \[IndentingNewLine]Plot[Det[{{\ \ \[Alpha]1\^2\ C1\^2, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]s\ \[Alpha]1\ C1\ \[Alpha]2\ \ C2\ , \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]1\ \ \[Alpha]1\ C1\ \[Nu]1\ \[Alpha]1, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ rc12\ \[Alpha]1\ C1\ \[Nu]2\ \[Alpha]2}, \[IndentingNewLine]{\ \[Rho]s\ \[Alpha]1\ C1\ \[Alpha]2\ \ C2\ , \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \((\[Alpha]2\ \ C2)\)\^2, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]c21\ \[Alpha]2\ C2\ \[Nu]1\ \[Alpha]1, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]2\ \[Alpha]2\ C2\ \[Nu]2\ \[Alpha]2}, \[IndentingNewLine]{\ \[Rho]1\ \ \[Alpha]1\ C1\ \[Nu]1\ \[Alpha]1, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]c21\ \[Alpha]2\ C2\ \[Nu]1\ \ \[Alpha]1, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \((\[Nu]1\ \[Alpha]1)\)\^2, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]v\ \[Nu]1\ \[Alpha]1\ \[Nu]2\ \[Alpha]2}, \[IndentingNewLine]{\ rc12\ \[Alpha]1\ C1\ \[Nu]2\ \[Alpha]2, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]2\ \[Alpha]2\ \ C2\ \[Nu]2\ \[Alpha]2\ , \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]v\ \[Nu]1\ \[Alpha]1\ \[Nu]2\ \[Alpha]2, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \((\[Nu]2\ \[Alpha]2)\)\^2}}], {rc12, \(-1\), \(+1\)}]; \[IndentingNewLine]Plot[Det[{{\ \ \[Alpha]1\^2\ C1\^2, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]s\ \[Alpha]1\ C1\ \[Alpha]2\ \ C2\ , \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]1\ \ \[Alpha]1\ C1\ \[Nu]1\ \[Alpha]1, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]c12\ \[Alpha]1\ C1\ \[Nu]2\ \[Alpha]2}, \[IndentingNewLine]{\ \[Rho]s\ \[Alpha]1\ C1\ \[Alpha]2\ \ C2\ , \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \((\[Alpha]2\ \ C2)\)\^2, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ rc21\ \[Alpha]2\ C2\ \[Nu]1\ \[Alpha]1, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]2\ \[Alpha]2\ C2\ \[Nu]2\ \[Alpha]2}, \[IndentingNewLine]{\ \[Rho]1\ \ \[Alpha]1\ C1\ \[Nu]1\ \[Alpha]1, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ rc21\ \[Alpha]2\ C2\ \[Nu]1\ \ \[Alpha]1, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \((\[Nu]1\ \[Alpha]1)\)\^2, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]v\ \[Nu]1\ \[Alpha]1\ \[Nu]2\ \[Alpha]2}, \[IndentingNewLine]{\ \[Rho]c12\ \[Alpha]1\ C1\ \[Nu]2\ \[Alpha]2, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]2\ \[Alpha]2\ \ C2\ \[Nu]2\ \[Alpha]2\ , \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]v\ \[Nu]1\ \[Alpha]1\ \[Nu]2\ \[Alpha]2, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \((\[Nu]2\ \[Alpha]2)\)\^2}}], {rc21, \(-1\), \(+1\)}]; \[IndentingNewLine]Print["\<Initial Eigenvalues=\>", Eigenvalues[COV0]]; \[IndentingNewLine]Print["\<Initial Det=\>", Det[COV0]]; \[IndentingNewLine]COV1 = {\[IndentingNewLine]{\ \ \[Alpha]1\^2\ C1\^2 + \[Alpha]2\^2\ C2\^2 - 2  \[Rho]s\ \[Alpha]1\ \[Alpha]2\ C1\ C2, \ \ \ \ \ \ \ \((\ \[Rho]s\ \[Alpha]1\ C1 - \ \ \[Alpha]2\ C2)\)\ \[Alpha]2\ \ C2\ , \ \ \ \ \ \((\ \[Rho]1\ \ \[Alpha]1\ C1 - \ \[Rho]c21\ \[Alpha]2\ C2)\) \[Nu]1\ \[Alpha]1, \ \ \ \ \ \((\[Rho]c12\ \[Alpha]1\ C1 - \ \[Rho]2\ \[Alpha]2\ C2)\)\ \[Nu]2\ \[Alpha]2}, \[IndentingNewLine]{\((\ \[Rho]s\ \[Alpha]1\ C1 - \ \ \[Alpha]2\ C2)\)\ \[Alpha]2\ \ C2, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \((\[Alpha]2\ \ C2)\)\^2, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]c21\ \[Alpha]2\ C2\ \[Nu]1\ \[Alpha]1, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]2\ \[Alpha]2\ C2\ \[Nu]2\ \[Alpha]2}, \[IndentingNewLine]{\((\ \[Rho]1\ \ \[Alpha]1\ C1 - \ \[Rho]c21\ \[Alpha]2\ C2)\)\ \[Nu]1\ \ \[Alpha]1, \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]c21\ \[Alpha]2\ C2\ \[Nu]1\ \ \[Alpha]1, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \((\[Nu]1\ \[Alpha]1)\)\^2, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]v\ \[Nu]1\ \[Alpha]1\ \[Nu]2\ \[Alpha]2}, \[IndentingNewLine]{\((\[Rho]c12\ \[Alpha]1\ C1 - \ \[Rho]2\ \[Alpha]2\ C2)\)\ \[Nu]2\ \[Alpha]2, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]2\ \[Alpha]2\ \ C2\ \[Nu]2\ \[Alpha]2\ , \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \[Rho]v\ \[Nu]1\ \[Alpha]1\ \[Nu]2\ \[Alpha]2, \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \((\[Nu]2\ \[Alpha]2)\)\^2}\[IndentingNewLine]}; \[IndentingNewLine]COV = {\[IndentingNewLine]{Q\^2, \[Rho]sb\ Q\ \[Alpha]2\ \ C2\ , \[Rho]s\[Alpha]1\ Q\ \[Nu]1\ \[Alpha]1, \[Rho]s\[Alpha]2\ Q\ \[Nu]2\ \[Alpha]2}, \[IndentingNewLine]{\[Rho]sb\ Q\ \[Alpha]2\ \ C2, \((\[Alpha]2\ \ C2)\)\^2, \[Rho]b\[Alpha]1\ \[Alpha]2\ C2\ \[Nu]1\ \[Alpha]1, \[Rho]b\[Alpha]2\ \[Alpha]2\ C2\ \[Nu]2\ \[Alpha]2}, \[IndentingNewLine]{\[Rho]s\[Alpha]1\ Q\ \[Nu]1\ \ \[Alpha]1, \[Rho]b\[Alpha]1\ \[Alpha]2\ C2\ \[Nu]1\ \ \[Alpha]1, \((\[Nu]1\ \[Alpha]1)\)\^2, \[Rho]v\ \[Nu]1\ \[Alpha]1\ \[Nu]2\ \[Alpha]2}, \[IndentingNewLine]{\[Rho]s\[Alpha]2\ Q\ \[Nu]2\ \[Alpha]2, \[Rho]b\[Alpha]2\ \[Alpha]2\ \ C2\ \[Nu]2\ \[Alpha]2\ , \[Rho]v\ \[Nu]1\ \[Alpha]1\ \[Nu]2\ \[Alpha]2, \((\[Nu]2\ \[Alpha]2)\)\^2}\[IndentingNewLine]}; \[IndentingNewLine]Print["\< COV1-COV=\>", COV1 - COV]; \[IndentingNewLine]N1 = {Q, 0, 0, 0} . \((COV . {Q, 0, 0, 0})\); \[IndentingNewLine]N2 = {Qs/Q, Qb/Q, Q1/Q, Q2/Q} . \((COV . {Qs/Q, Qb/Q, Q1/Q, Q2/Q})\); \[IndentingNewLine]\[Nu]spZ = \@N2\/Q; \[IndentingNewLine]\[Rho]spZ = \(({Q, 0, 0, 0} . \((COV . {Qs/Q, Qb/Q, Q1/Q, Q2/Q})\))\)/\@\(N2\ N1\); \[IndentingNewLine]Print["\<BiSABRSpreadOption:N1=\>", N1]; Print["\<BiSABRSpreadOption:N2=\>", N2]; \[IndentingNewLine]Print["\<BiSABRSpreadOption:\[Nu]spZ=\>", \[Nu]spZ]; Print["\<BiSABRSpreadOption:\[Rho]spZ=\>", \[Rho]spZ]; \[IndentingNewLine]Print["\<BiSABRSpreadOption:ds=\>", {Q, 0, 0, 0}]; Print[\*"\"\<BiSABRSpreadOption:\!\(d\[Alpha]\_11\)=\>\"", {Qs/Q, Qb/Q, Q1/Q, Q2/Q}]; \[IndentingNewLine]Print["\<BiSABRSpreadOption:COV=\>", COV]; \[IndentingNewLine]Print["\<BiSABRSpreadOption:eigenvalues=\>", Eigenvalues[COV]]; \[IndentingNewLine]Print["\<BiSABRSpreadOption: Det=\>", Det[COV]];\[IndentingNewLine]]; \[IndentingNewLine]Re[SABRgeneric5[intrinsec, z, b1, b2, zavg, SqB0B\[Alpha]z, T, \[Mu]sp, \[Alpha]sp, \[Rho]sp, \[Nu]sp, printflag]]]\)

On[General::"spell"]



\!\(BiSABRSpreadOption[F1_, \[Alpha]1_, \[Beta]1_, \[Rho]1_, \[Nu]1_, F2_, \[Alpha]2_, \[Beta]2_, \[Rho]2_, \[Nu]2_, K_, T_, \[Rho]s_, \[Rho]v_, \[Rho]c12_, \[Rho]c21_, legendrelst_, printflag_] := Module[\[IndentingNewLine]{intrinsec, z, b1, b2, SqB0B\[Alpha]z, favg, zavg, Ck, \[Alpha]sp, \[Nu]sp, \[Rho]sp, \[Mu]sp, X1, X2, Qs, Q1, Q2, Qb, C1, C2, C1p, C2p, Q, COV, COV1, COV0, \[Rho]sb, \[Rho]s\[Alpha]1, \[Rho]s\[Alpha]2, \[Rho]b\[Alpha]1, \[Rho]b\[Alpha]2, N1, N2, \[Nu]spZ, \[Rho]spZ}, \[IndentingNewLine]X1 = F1\^\(\(\ \)\(\[Beta]1\)\); X2 = F2\^\[Beta]2; \[Alpha]sp = \@\(X1\^\(\(2\)\(\ \)\)\ \[Alpha]1\^2 + X2\^\(\(2\)\(\ \)\)\ \[Alpha]2\^2 - 2\ X1\ X2\ \[Alpha]1\ \[Alpha]2\ \[Rho]s\); \[IndentingNewLine]\[Nu]sp = \[Nu]BiSABR1[F1, \[Alpha]1, \[Beta]1, \[Rho]1, \[Nu]1, F2, \[Alpha]2, \[Beta]2, \[Rho]2, \[Nu]2, \[Rho]s, \[Rho]v, \[Rho]c12, \[Rho]c21, X1, X2, \[Alpha]sp]; \[IndentingNewLine]\[Rho]sp = \[Rho]BiSABR1[F1, \[Alpha]1, \[Beta]1, \[Rho]1, \[Nu]1, F2, \[Alpha]2, \[Beta]2, \[Rho]2, \[Nu]2, \[Rho]s, \[Rho]v, \[Rho]c12, \[Rho]c21, X1, X2, \[Alpha]sp, \[Nu]sp]; \[IndentingNewLine]\[Mu]sp = \[Mu]BiSABR1[F1, \[Alpha]1, \[Beta]1, \[Rho]1, \[Nu]1, F2, \[Alpha]2, \[Beta]2, \[Rho]2, \[Nu]2, \[Rho]s, \[Rho]v, \[Rho]c12, \[Rho]c21, X1, X2, \[Alpha]sp]; \[IndentingNewLine]z = BiSABRz[K, F1, F2, \[Alpha]1, \[Alpha]2, \[Rho]s, \[Beta]1, \[Beta]2, legendrelst]; \[IndentingNewLine]favg = \((F1 - F2 + K)\)/2; \[IndentingNewLine]zavg = BiSABRz[favg, F1, F2, \[Alpha]1, \[Alpha]2, \[Rho]s, \[Beta]1, \[Beta]2, legendrelst]; \[IndentingNewLine]b1 = BiSABRspreadCderivative[F1, F2, \[Alpha]1, \[Alpha]2, \[Beta]1, \[Beta]2, \[Rho]s, X1, X2, \[Alpha]sp, favg]; \[IndentingNewLine]Csecond = BiSABRspreadCderivative2[F1, F2, \[Alpha]1, \[Alpha]2, \[Beta]1, \[Beta]2, \[Rho]s, X1, X2, \[Alpha]sp, favg]; \[IndentingNewLine]Cfavg = BiSABRspreadC[F1, F2, \[Alpha]1, \[Alpha]2, \[Beta]1, \[Beta]2, \[Rho]s, X1, X2, \[Alpha]sp, favg]; \[IndentingNewLine]Ck = BiSABRspreadC[F1, F2, \[Alpha]1, \[Alpha]2, \[Beta]1, \[Beta]2, \[Rho]s, X1, X2, \[Alpha]sp, K]; \[IndentingNewLine]b2 = Csecond\ Cfavg + b1\^2; \[IndentingNewLine]SqB0B\[Alpha]z = \@Ck; \[IndentingNewLine]intrinsec = Max[F1 - F2 - K, 0]; \[IndentingNewLine]If[printflag == 10, Print["\<BiSABRSpreadOption:X1=\>", X1, "\< X2=\>", X2, "\< z=\>", z]]; \[IndentingNewLine]If[printflag == 10, Print["\<BiSABRSpreadOption:b1=\>", b1, "\< b2=\>", b2, "\< SqB0B\[Alpha]z=\>", SqB0B\[Alpha]z]]; \[IndentingNewLine]If[printflag == 10, Print["\<BiSABRSpreadOption:\[Alpha]=\>", \[Alpha]sp, "\< \[Nu]=\>", \[Nu]sp, "\< \[Rho]=\>", \[Rho]sp, "\<  \[Mu]=\>", \[Mu]sp]]; \[IndentingNewLine]res = SABRgeneric5[intrinsec, z, b1, b2, zavg, SqB0B\[Alpha]z, T, \[Mu]sp, \[Alpha]sp, \[Rho]sp, \[Nu]sp, printflag]; \[IndentingNewLine]If[printflag == 10, Print["\<BiSABRSpreadOption:res=\>", res]]; \[IndentingNewLine]Re[res]]\)

BiSABRSpreadOptionVol[F1_,\[Alpha]1_,\[Beta]1_,\[Rho]1_,\[Nu]1_,
    F2_,\[Alpha]2_,\[Beta]2_,\[Rho]2_,\[Nu]2_,K_,
    T_,\[Rho]s_,\[Rho]v_,\[Rho]c12_,\[Rho]c21_,legendrelst_,printflag_]:=
  NormalImplicitVol[F1-F2,K,T,
    BiSABRSpreadOption[F1,\[Alpha]1,\[Beta]1,\[Rho]1,\[Nu]1,
      F2,\[Alpha]2,\[Beta]2,\[Rho]2,\[Nu]2,K,
      T,\[Rho]s,\[Rho]v,\[Rho]c12,\[Rho]c21,legendrelst,0]]


BiSABRSpreadOptionNormalCorrelation[F1_,\[Alpha]1_,\[Beta]1_,\[Rho]1_,\[Nu]1_,
    F2_,\[Alpha]2_,\[Beta]2_,\[Rho]2_,\[Nu]2_,K_,
    T_,\[Rho]s_,\[Rho]v_,\[Rho]c12_,\[Rho]c21_,legendrelst_,printflag_]:=
  Module[{method="Directe",zetavmethod="Exact",zmethod="Exact",
      favmethod ="Arithmetic",\[Sigma]ATMnormal1,\[Sigma]ATMnormal2,
      implicitNormalvols},
    {\[Sigma]ATMnormal1,\[Sigma]ATMnormal2}={F1 SABROption[
              F1,\[Alpha]1,\[Beta]1,\[Rho]1,\[Nu]1,{method,zmethod,
                zetavmethod,favmethod},F1 1.0001,T][[1]],
        F2 SABROption[
              F2,\[Alpha]2,\[Beta]2,\[Rho]2,\[Nu]2,{method,zmethod,
                zetavmethod,favmethod},F2 1.0001,T][[1]]};
    implicitNormalvols=
      BiSABRSpreadOptionVol[F1,\[Alpha]1,\[Beta]1,\[Rho]1,\[Nu]1,
        F2,\[Alpha]2,\[Beta]2,\[Rho]2,\[Nu]2,K,
        T,\[Rho]s,\[Rho]v,\[Rho]c12,\[Rho]c21,legendrelst,0];
    NormalImplicitCorrelation[\[Sigma]ATMnormal1,\[Sigma]ATMnormal2,
      implicitNormalvols]]



BiSABRSpreadOptionCorrected[F1_,\[Alpha]1_,\[Beta]1_,\[Rho]1_,\[Nu]1_,
    F2_,\[Alpha]2_,\[Beta]2_,\[Rho]2_,\[Nu]2_,K_,
    T_,\[Rho]s_,\[Rho]v_,\[Rho]c12_,\[Rho]c21_,legendrelst_,
    printflag_]:=(BiSABRSpreadOption[F1,\[Alpha]1,\[Beta]1,\[Rho]1,\[Nu]1,
          F2,\[Alpha]2,\[Beta]2,\[Rho]2,\[Nu]2,K,
          T,\[Rho]s,\[Rho]v,\[Rho]c12,\[Rho]c21,legendrelst,printflag]+
        BiSABRSpreadOption[F2,\[Alpha]2,\[Beta]2,\[Rho]2,\[Nu]2,
          F1,\[Alpha]1,\[Beta]1,\[Rho]1,\[Nu]1,-K,
          T,\[Rho]s,\[Rho]v,\[Rho]c21,\[Rho]c12,legendrelst,printflag]+F1-F2-
        K)/2





\!\(GeneralizedBiSABRSpreadOption[F1_, \[Alpha]1_, \[Beta]1_, \[Rho]1_, \[Nu]1_, F2_, \[Alpha]2_, \[Beta]2_, \[Rho]2_, \[Nu]2_, K_, T_, \[Rho]s_, \[Rho]v_, \[Rho]c12_, \[Rho]c21_, a1_, a2_, printflag_] := Module[{}, \[IndentingNewLine]BiSABRSpreadOption[a1\ F1, \[Alpha]1\ a1\^\(1 - \[Beta]1\), \[Beta]1, \[Rho]1, \[Nu]1, a2\ F2, \[Alpha]2\ a2\^\(1 - \[Beta]2\), \[Beta]2, \[Rho]2, \[Nu]2, K, T, \[Rho]s, \[Rho]v, \[Rho]c12, \[Rho]c21, printflag]\[IndentingNewLine]]\)

\!\(GeneralizedBiSABRSpreadOption[F1_, \[Alpha]1_, \[Beta]1_, \[Rho]1_, \[Nu]1_, F2_, \[Alpha]2_, \[Beta]2_, \[Rho]2_, \[Nu]2_, K_, T_, \[Rho]s_, \[Rho]v_, \[Rho]c12_, \[Rho]c21_, a1_, a2_, legendrelst_, printflag_] := Module[{}, \[IndentingNewLine]BiSABRSpreadOption[a1\ F1, \[Alpha]1\ a1\^\(1 - \[Beta]1\), \[Beta]1, \[Rho]1, \[Nu]1, a2\ F2, \[Alpha]2\ a2\^\(1 - \[Beta]2\), \[Beta]2, \[Rho]2, \[Nu]2, K, T, \[Rho]s, \[Rho]v, \[Rho]c12, \[Rho]c21, legendrelst, printflag]\[IndentingNewLine]]\)



TestCorrelation[\[Rho]1_,\[Rho]2_,\[Rho]s_,\[Rho]v_,\[Rho]c12_,\[Rho]c21_]:=
    Module[{},
      Print["Test Correlation : Eigenvalues=",
        Eigenvalues[{{1,\[Rho]1,\[Rho]s,\[Rho]c12},{\[Rho]1,
              1,\[Rho]c21,\[Rho]v},{\[Rho]s,\[Rho]c21,
              1,\[Rho]2},{\[Rho]c12,\[Rho]v,\[Rho]2,1}}]]];




Module[{
    F1=0.0418,
    \[Alpha]1=0.0435,
    \[Beta]1=0.6,
    \[Rho]1=-0.1819,
    \[Nu]1=0.3798,
    F2=0.0363,
    \[Alpha]2=0.0671,
    \[Beta]2=0.7,
    \[Rho]2=-0.1136,
    \[Nu]2=0.3797,
    T=1,
    \[Rho]s=0.808,
    \[Rho]v=0.,
    \[Rho]c12=-0.2,
    \[Rho]c21=0.,
    K=-0.002,legendrelst=LegendreCoeffs[10]
    },
  {BiSABRSpreadOption[F1,\[Alpha]1,\[Beta]1,\[Rho]1,\[Nu]1,
      F2,\[Alpha]2,\[Beta]2,\[Rho]2,\[Nu]2,K,
      T,\[Rho]s,\[Rho]v,\[Rho]c12,\[Rho]c21,legendrelst,0],
    BiSABRSpreadOptionCorrected[F1,\[Alpha]1,\[Beta]1,\[Rho]1,\[Nu]1,
      F2,\[Alpha]2,\[Beta]2,\[Rho]2,\[Nu]2,K,
      T,\[Rho]s,\[Rho]v,\[Rho]c12,\[Rho]c21,legendrelst,0]}]





































\!\(BiSABRNormalHestonSpreadOption[F1_, \[Alpha]1_, \[Beta]1_, \[Rho]1_, \[Nu]1_, F2_, \[Alpha]2_, \[Beta]2_, \[Rho]2_, \[Nu]2_, K_, T_, \[Rho]s_, \[Rho]v_, \[Rho]c12_, \[Rho]c21_, printflag_] := Module[\[IndentingNewLine]{intrinsec, z, b1, b2, SqB0B\[Alpha]z, favg, zavg, Ck, \[Alpha]sp, \[Nu]sp, \[Rho]sp, \[Mu]sp, X1, X2, Qs, Q1, Q2, Qb, C1, C2, C1p, C2p, Q, COV, COV1, COV0, \[Rho]sb, \[Rho]s\[Alpha]1, \[Rho]s\[Alpha]2, \[Rho]b\[Alpha]1, \[Rho]b\[Alpha]2, N1, N2, \[Nu]spZ, \[Rho]spZ}, \[IndentingNewLine]X1 = F1\^\(\(\ \)\(\[Beta]1\)\); X2 = F2\^\[Beta]2; \[Alpha]sp = \@\(X1\^\(\(2\)\(\ \)\)\ \[Alpha]1\^2 + X2\^\(\(2\)\(\ \)\)\ \[Alpha]2\^2 - 2\ X1\ X2\ \[Alpha]1\ \[Alpha]2\ \[Rho]s\); \[IndentingNewLine]\[Nu]sp = \[Nu]BiSABR1[F1, \[Alpha]1, \[Beta]1, \[Rho]1, \[Nu]1, F2, \[Alpha]2, \[Beta]2, \[Rho]2, \[Nu]2, \[Rho]s, \[Rho]v, \[Rho]c12, \[Rho]c21, X1, X2, \[Alpha]sp]; \[IndentingNewLine]\[Rho]sp = \[Rho]BiSABR1[F1, \[Alpha]1, \[Beta]1, \[Rho]1, \[Nu]1, F2, \[Alpha]2, \[Beta]2, \[Rho]2, \[Nu]2, \[Rho]s, \[Rho]v, \[Rho]c12, \[Rho]c21, X1, X2, \[Alpha]sp, \[Nu]sp]; \[IndentingNewLine]\[Mu]sp = \[Mu]BiSABR1[F1, \[Alpha]1, \[Beta]1, \[Rho]1, \[Nu]1, F2, \[Alpha]2, \[Beta]2, \[Rho]2, \[Nu]2, \[Rho]s, \[Rho]v, \[Rho]c12, \[Rho]c21, X1, X2, \[Alpha]sp]; \[IndentingNewLine]\[Kappa] = 2  \[Nu]sp\ \[Alpha]sp; \[IndentingNewLine]\ \[Lambda] = Max[Abs[\((\[Kappa]\^2\/2 - \((2  \[Mu]sp\ \[Alpha]sp\^2\  + \[Nu]sp\^2\ \[Alpha]sp\^2\ )\))\)\/\[Alpha]sp\^2], 10^\((\(-8\))\)]\ ; \[IndentingNewLine]\ \ \[Theta] = Min[Abs[\[Kappa]\^2\/\(2  \[Lambda]\)], 100\ Abs[\[Alpha]sp^2]]; \[IndentingNewLine]\ \[Lambda] = \((\[Kappa]\^2\/2 - \((2  \[Mu]sp\ \[Alpha]sp\^2\  + \[Nu]sp\^2\ \[Alpha]sp\^2\ )\))\)\/\[Alpha]sp\^2; \[IndentingNewLine]\ \ \[Theta] = \[Kappa]\^2\/\(2  \[Lambda]\); \[IndentingNewLine]\[Lambda]2 = 0.5; \[IndentingNewLine]S0 = F1 - F2; \[IndentingNewLine]If[printflag > 0, Print["\<BiSABRNormalHestonSpreadOption: \[Lambda]=\>", \[Lambda], "\< \[Theta]=\>", \[Theta], "\< \[Kappa]=\>", \[Kappa], "\< \[Alpha]sp=\>", \[Alpha]sp]]; \[IndentingNewLine]Re[ExpectedGaussianHestonPayOffInf[\[Rho]sp, 0.0, \[Lambda]2, \[Lambda], \[Theta], \[Kappa], S0, K, \[Alpha]sp\^2, T]]]\)

\!\(\(BiSABRNormalHestonSpreadOptionCompute\[Alpha][F1_, \[Alpha]1_, \[Beta]1_, \[Rho]1_, \[Nu]1_, F2_, \[Alpha]2_, \[Beta]2_, \[Rho]2_, \[Nu]2_, \[Rho]s_, \[Rho]v_, \[Rho]c12_, \[Rho]c21_, printflag_] := Module[\[IndentingNewLine]{intrinsec, z, b1, b2, SqB0B\[Alpha]z, favg, zavg, Ck, \[Alpha]sp, \[Nu]sp, \[Rho]sp, \[Mu]sp, X1, X2, Qs, Q1, Q2, Qb, C1, C2, C1p, C2p, Q, COV, COV1, COV0, \[Rho]sb, \[Rho]s\[Alpha]1, \[Rho]s\[Alpha]2, \[Rho]b\[Alpha]1, \[Rho]b\[Alpha]2, N1, N2, \[Nu]spZ, \[Rho]spZ}, \[IndentingNewLine]X1 = F1\^\(\(\ \)\(\[Beta]1\)\); X2 = F2\^\[Beta]2; \[Alpha]sp = \@\(X1\^\(\(2\)\(\ \)\)\ \[Alpha]1\^2 + X2\^\(\(2\)\(\ \)\)\ \[Alpha]2\^2 - 2\ X1\ X2\ \[Alpha]1\ \[Alpha]2\ \[Rho]s\)];\)\)

\!\(\(BiSABRNormalHestonSpreadOptionCompute\[Nu][F1_, \[Alpha]1_, \[Beta]1_, \[Rho]1_, \[Nu]1_, F2_, \[Alpha]2_, \[Beta]2_, \[Rho]2_, \[Nu]2_, \[Rho]s_, \[Rho]v_, \[Rho]c12_, \[Rho]c21_, printflag_] := Module[\[IndentingNewLine]{intrinsec, z, b1, b2, SqB0B\[Alpha]z, favg, zavg, Ck, \[Alpha]sp, \[Nu]sp, \[Rho]sp, \[Mu]sp, X1, X2, Qs, Q1, Q2, Qb, C1, C2, C1p, C2p, Q, COV, COV1, COV0, \[Rho]sb, \[Rho]s\[Alpha]1, \[Rho]s\[Alpha]2, \[Rho]b\[Alpha]1, \[Rho]b\[Alpha]2, N1, N2, \[Nu]spZ, \[Rho]spZ}, \[IndentingNewLine]X1 = F1\^\(\(\ \)\(\[Beta]1\)\); X2 = F2\^\[Beta]2; \[Alpha]sp = \@\(X1\^\(\(2\)\(\ \)\)\ \[Alpha]1\^2 + X2\^\(\(2\)\(\ \)\)\ \[Alpha]2\^2 - 2\ X1\ X2\ \[Alpha]1\ \[Alpha]2\ \[Rho]s\); \[IndentingNewLine]\[Nu]BiSABR1[F1, \[Alpha]1, \[Beta]1, \[Rho]1, \[Nu]1, F2, \[Alpha]2, \[Beta]2, \[Rho]2, \[Nu]2, \[Rho]s, \[Rho]v, \[Rho]c12, \[Rho]c21, X1, X2, \[Alpha]sp]];\)\)

\!\(\(BiSABRNormalHestonSpreadOptionCompute\[Rho][F1_, \[Alpha]1_, \[Beta]1_, \[Rho]1_, \[Nu]1_, F2_, \[Alpha]2_, \[Beta]2_, \[Rho]2_, \[Nu]2_, \[Rho]s_, \[Rho]v_, \[Rho]c12_, \[Rho]c21_, printflag_] := Module[\[IndentingNewLine]{intrinsec, z, b1, b2, SqB0B\[Alpha]z, favg, zavg, Ck, \[Alpha]sp, \[Nu]sp, \[Rho]sp, \[Mu]sp, X1, X2, Qs, Q1, Q2, Qb, C1, C2, C1p, C2p, Q, COV, COV1, COV0, \[Rho]sb, \[Rho]s\[Alpha]1, \[Rho]s\[Alpha]2, \[Rho]b\[Alpha]1, \[Rho]b\[Alpha]2, N1, N2, \[Nu]spZ, \[Rho]spZ}, \[IndentingNewLine]X1 = F1\^\(\(\ \)\(\[Beta]1\)\); X2 = F2\^\[Beta]2; \[Alpha]sp = \@\(X1\^\(\(2\)\(\ \)\)\ \[Alpha]1\^2 + X2\^\(\(2\)\(\ \)\)\ \[Alpha]2\^2 - 2\ X1\ X2\ \[Alpha]1\ \[Alpha]2\ \[Rho]s\); \[IndentingNewLine]\[Nu]sp = \[Nu]BiSABR1[F1, \[Alpha]1, \[Beta]1, \[Rho]1, \[Nu]1, F2, \[Alpha]2, \[Beta]2, \[Rho]2, \[Nu]2, \[Rho]s, \[Rho]v, \[Rho]c12, \[Rho]c21, X1, X2, \[Alpha]sp]; \[IndentingNewLine]\[Rho]BiSABR1[F1, \[Alpha]1, \[Beta]1, \[Rho]1, \[Nu]1, F2, \[Alpha]2, \[Beta]2, \[Rho]2, \[Nu]2, \[Rho]s, \[Rho]v, \[Rho]c12, \[Rho]c21, X1, X2, \[Alpha]sp, \[Nu]sp]];\)\)

\!\(\(BiSABRNormalHestonSpreadOptionCompute\[Mu][F1_, \[Alpha]1_, \[Beta]1_, \[Rho]1_, \[Nu]1_, F2_, \[Alpha]2_, \[Beta]2_, \[Rho]2_, \[Nu]2_, \[Rho]s_, \[Rho]v_, \[Rho]c12_, \[Rho]c21_, printflag_] := Module[\[IndentingNewLine]{intrinsec, z, b1, b2, SqB0B\[Alpha]z, favg, zavg, Ck, \[Alpha]sp, \[Nu]sp, \[Rho]sp, \[Mu]sp, X1, X2, Qs, Q1, Q2, Qb, C1, C2, C1p, C2p, Q, COV, COV1, COV0, \[Rho]sb, \[Rho]s\[Alpha]1, \[Rho]s\[Alpha]2, \[Rho]b\[Alpha]1, \[Rho]b\[Alpha]2, N1, N2, \[Nu]spZ, \[Rho]spZ}, \[IndentingNewLine]X1 = F1\^\(\(\ \)\(\[Beta]1\)\); X2 = F2\^\[Beta]2; \[Alpha]sp = \@\(X1\^\(\(2\)\(\ \)\)\ \[Alpha]1\^2 + X2\^\(\(2\)\(\ \)\)\ \[Alpha]2\^2 - 2\ X1\ X2\ \[Alpha]1\ \[Alpha]2\ \[Rho]s\); \[IndentingNewLine]\[Mu]BiSABR1[F1, \[Alpha]1, \[Beta]1, \[Rho]1, \[Nu]1, F2, \[Alpha]2, \[Beta]2, \[Rho]2, \[Nu]2, \[Rho]s, \[Rho]v, \[Rho]c12, \[Rho]c21, X1, X2, \[Alpha]sp]];\)\)

\!\(\(BiSABRNormalHestonSpreadOptionCompute\[Kappa][F1_, \[Alpha]1_, \[Beta]1_, \[Rho]1_, \[Nu]1_, F2_, \[Alpha]2_, \[Beta]2_, \[Rho]2_, \[Nu]2_, \[Rho]s_, \[Rho]v_, \[Rho]c12_, \[Rho]c21_, printflag_] := Module[\[IndentingNewLine]{intrinsec, z, b1, b2, SqB0B\[Alpha]z, favg, zavg, Ck, \[Alpha]sp, \[Nu]sp, \[Rho]sp, \[Mu]sp, X1, X2, Qs, Q1, Q2, Qb, C1, C2, C1p, C2p, Q, COV, COV1, COV0, \[Rho]sb, \[Rho]s\[Alpha]1, \[Rho]s\[Alpha]2, \[Rho]b\[Alpha]1, \[Rho]b\[Alpha]2, N1, N2, \[Nu]spZ, \[Rho]spZ}, \[IndentingNewLine]X1 = F1\^\(\(\ \)\(\[Beta]1\)\); X2 = F2\^\[Beta]2; \[Alpha]sp = \@\(X1\^\(\(2\)\(\ \)\)\ \[Alpha]1\^2 + X2\^\(\(2\)\(\ \)\)\ \[Alpha]2\^2 - 2\ X1\ X2\ \[Alpha]1\ \[Alpha]2\ \[Rho]s\); \[IndentingNewLine]\[Nu]sp = \[Nu]BiSABR1[F1, \[Alpha]1, \[Beta]1, \[Rho]1, \[Nu]1, F2, \[Alpha]2, \[Beta]2, \[Rho]2, \[Nu]2, \[Rho]s, \[Rho]v, \[Rho]c12, \[Rho]c21, X1, X2, \[Alpha]sp]; \[IndentingNewLine]2  \[Nu]sp\ \[Alpha]sp];\)\)

\!\(BiSABRNormalHestonSpreadOptionCompute\[Lambda][F1_, \[Alpha]1_, \[Beta]1_, \[Rho]1_, \[Nu]1_, F2_, \[Alpha]2_, \[Beta]2_, \[Rho]2_, \[Nu]2_, \[Rho]s_, \[Rho]v_, \[Rho]c12_, \[Rho]c21_, printflag_] := Module[\[IndentingNewLine]{intrinsec, z, b1, b2, SqB0B\[Alpha]z, favg, zavg, Ck, \[Alpha]sp, \[Nu]sp, \[Rho]sp, \[Mu]sp, X1, X2, Qs, Q1, Q2, Qb, C1, C2, C1p, C2p, Q, COV, COV1, COV0, \[Rho]sb, \[Rho]s\[Alpha]1, \[Rho]s\[Alpha]2, \[Rho]b\[Alpha]1, \[Rho]b\[Alpha]2, N1, N2, \[Nu]spZ, \[Rho]spZ}, \[IndentingNewLine]X1 = F1\^\(\(\ \)\(\[Beta]1\)\); X2 = F2\^\[Beta]2; \[Alpha]sp = \@\(X1\^\(\(2\)\(\ \)\)\ \[Alpha]1\^2 + X2\^\(\(2\)\(\ \)\)\ \[Alpha]2\^2 - 2\ X1\ X2\ \[Alpha]1\ \[Alpha]2\ \[Rho]s\); \[IndentingNewLine]\[Nu]sp = \[Nu]BiSABR1[F1, \[Alpha]1, \[Beta]1, \[Rho]1, \[Nu]1, F2, \[Alpha]2, \[Beta]2, \[Rho]2, \[Nu]2, \[Rho]s, \[Rho]v, \[Rho]c12, \[Rho]c21, X1, X2, \[Alpha]sp]; \[IndentingNewLine]\[Rho]sp = \[Rho]BiSABR1[F1, \[Alpha]1, \[Beta]1, \[Rho]1, \[Nu]1, F2, \[Alpha]2, \[Beta]2, \[Rho]2, \[Nu]2, \[Rho]s, \[Rho]v, \[Rho]c12, \[Rho]c21, X1, X2, \[Alpha]sp, \[Nu]sp]; \[IndentingNewLine]\[Kappa] = 2  \[Nu]sp\ \[Alpha]sp; \[IndentingNewLine]\ \ \[Theta] = \[Alpha]sp\^2; \[IndentingNewLine]\ \[Lambda] = \((\[Kappa]\^2\/2 - \((2  \[Mu]sp\ \[Alpha]sp\^2\  + \[Nu]sp\^2\ \[Alpha]sp\^2\ )\))\)\/\[Alpha]sp\^2]\)

BiSABRNormalHestonSpreadOptionComputeParameters[
    F1_,\[Alpha]1_,\[Beta]1_,\[Rho]1_,\[Nu]1_,
    F2_,\[Alpha]2_,\[Beta]2_,\[Rho]2_,\[Nu]2_,\[Rho]s_,\[Rho]v_,\[Rho]c12_,\
\[Rho]c21_,printflag_]:=
  Module[{},\[Alpha]=
      BiSABRNormalHestonSpreadOptionCompute\[Alpha][
        F1,\[Alpha]1,\[Beta]1,\[Rho]1,\[Nu]1,
        F2,\[Alpha]2,\[Beta]2,\[Rho]2,\[Nu]2,\[Rho]s,\[Rho]v,\[Rho]c12,\[Rho]\
c21,printflag];
    \[Alpha]=
      BiSABRNormalHestonSpreadOptionCompute\[Alpha][
        F1,\[Alpha]1,\[Beta]1,\[Rho]1,\[Nu]1,
        F2,\[Alpha]2,\[Beta]2,\[Rho]2,\[Nu]2,\[Rho]s,\[Rho]v,\[Rho]c12,\[Rho]\
c21,printflag];
    \[Nu]=
      BiSABRNormalHestonSpreadOptionCompute\[Nu][
        F1,\[Alpha]1,\[Beta]1,\[Rho]1,\[Nu]1,
        F2,\[Alpha]2,\[Beta]2,\[Rho]2,\[Nu]2,\[Rho]s,\[Rho]v,\[Rho]c12,\[Rho]\
c21,printflag];
    \[Rho]=
      BiSABRNormalHestonSpreadOptionCompute\[Rho][
        F1,\[Alpha]1,\[Beta]1,\[Rho]1,\[Nu]1,
        F2,\[Alpha]2,\[Beta]2,\[Rho]2,\[Nu]2,\[Rho]s,\[Rho]v,\[Rho]c12,\[Rho]\
c21,printflag];
    \[Kappa]=
      BiSABRNormalHestonSpreadOptionCompute\[Kappa][
        F1,\[Alpha]1,\[Beta]1,\[Rho]1,\[Nu]1,
        F2,\[Alpha]2,\[Beta]2,\[Rho]2,\[Nu]2,\[Rho]s,\[Rho]v,\[Rho]c12,\[Rho]\
c21,printflag];
    
    \[Lambda]=
      BiSABRNormalHestonSpreadOptionCompute\[Lambda][
        F1,\[Alpha]1,\[Beta]1,\[Rho]1,\[Nu]1,
        F2,\[Alpha]2,\[Beta]2,\[Rho]2,\[Nu]2,\[Rho]s,\[Rho]v,\[Rho]c12,\[Rho]\
c21,printflag];
    Print["\[Alpha]=",\[Alpha]," \[Nu]=",\[Nu]," \[Rho]=",\[Rho],
      " \[Kappa]=",\[Kappa]," \[Lambda]=",\[Lambda]];
    ]




\!\(BiSABRNormalHestonSpreadOption2[F1_, \[Alpha]1_, \[Beta]1_, \[Rho]1_, \[Nu]1_, F2_, \[Alpha]2_, \[Beta]2_, \[Rho]2_, \[Nu]2_, K_, T_, \[Rho]s_, \[Rho]v_, \[Rho]c12_, \[Rho]c21_, printflag_] := Module[\[IndentingNewLine]{intrinsec, z, b1, b2, SqB0B\[Alpha]z, favg, zavg, Ck, \[Alpha]sp, \[Nu]sp, \[Rho]sp, \[Mu]sp, X1, X2, Qs, Q1, Q2, Qb, C1, C2, C1p, C2p, Q, COV, COV1, COV0, \[Rho]sb, \[Rho]s\[Alpha]1, \[Rho]s\[Alpha]2, \[Rho]b\[Alpha]1, \[Rho]b\[Alpha]2, N1, N2, \[Nu]spZ, \[Rho]spZ}, \[IndentingNewLine]X1 = F1\^\(\(\ \)\(\[Beta]1\)\); X2 = F2\^\[Beta]2; \[Alpha]sp = \@\(X1\^\(\(2\)\(\ \)\)\ \[Alpha]1\^2 + X2\^\(\(2\)\(\ \)\)\ \[Alpha]2\^2 - 2\ X1\ X2\ \[Alpha]1\ \[Alpha]2\ \[Rho]s\); \[IndentingNewLine]\[Nu]sp = \[Nu]BiSABR1[F1, \[Alpha]1, \[Beta]1, \[Rho]1, \[Nu]1, F2, \[Alpha]2, \[Beta]2, \[Rho]2, \[Nu]2, \[Rho]s, \[Rho]v, \[Rho]c12, \[Rho]c21, X1, X2, \[Alpha]sp]; \[IndentingNewLine]\[Rho]sp = \[Rho]BiSABR1[F1, \[Alpha]1, \[Beta]1, \[Rho]1, \[Nu]1, F2, \[Alpha]2, \[Beta]2, \[Rho]2, \[Nu]2, \[Rho]s, \[Rho]v, \[Rho]c12, \[Rho]c21, X1, X2, \[Alpha]sp, \[Nu]sp]; \[IndentingNewLine]\[Mu]sp = \[Mu]BiSABR1[F1, \[Alpha]1, \[Beta]1, \[Rho]1, \[Nu]1, F2, \[Alpha]2, \[Beta]2, \[Rho]2, \[Nu]2, \[Rho]s, \[Rho]v, \[Rho]c12, \[Rho]c21, X1, X2, \[Alpha]sp]; \[IndentingNewLine]\[Kappa] = 2  \[Nu]sp\ \[Alpha]sp; \[IndentingNewLine]\ \ \[Theta] = \[Alpha]sp\^2; \[IndentingNewLine]\[Lambda] = \[Kappa]\^2\/\(2  \[Theta]\); \[IndentingNewLine]\[Lambda]2 = 0.5; \[IndentingNewLine]S0 = F1 - F2; \[IndentingNewLine]Re[ExpectedGaussianHestonPayOffInf[\[Rho]sp, 0.0, \[Lambda]2, \[Lambda], \[Theta], \[Kappa], S0, K, \[Alpha]sp\^2, T]]]\)



























































































































